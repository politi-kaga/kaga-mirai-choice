<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>候補者詳細ページ生成ツール</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'ヒラギノ角ゴシック', 'Yu Gothic', 'メイリオ', sans-serif;
            margin: 2rem;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .button {
            background: #3b82f6;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 1rem 0;
        }
        .button:hover {
            background: #2563eb;
        }
        .output {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.loading {
            background: #fef3c7;
            color: #92400e;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .instructions {
            background: #e0f2fe;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #0369a1;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 候補者詳細ページ生成ツール</h1>
        
        <div class="instructions">
            <h3>📋 使用方法</h3>
            <ol>
                <li>「ページ生成開始」ボタンをクリックしてください</li>
                <li>APIから候補者データを取得し、各候補者の詳細ページHTMLを生成します</li>
                <li>生成されたHTMLコードをコピーして、対応するファイルに保存してください</li>
                <li>ファイル名は <code>candidate-1.html</code>, <code>candidate-2.html</code> などです</li>
            </ol>
            
            <h3>💾 ファイル保存先</h3>
            <div class="code-block">
/home/user/webapp/candidates/
├── index.html (既存)
├── candidate-1.html (新規作成)
├── candidate-2.html (新規作成)
└── ... (候補者数分作成)
            </div>
        </div>
        
        <button class="button" onclick="startGeneration()">🔄 ページ生成開始</button>
        
        <div id="status"></div>
        <div id="output"></div>
        
        <div class="instructions">
            <h3>⚠️ 注意事項</h3>
            <ul>
                <li>このツールはブラウザ上で動作し、ファイルを直接作成することはできません</li>
                <li>生成されたHTMLコードを手動でファイルに保存する必要があります</li>
                <li>候補者データはAPIから動的に取得されます</li>
                <li>全ての候補者ページが生成されるまで時間がかかる場合があります</li>
            </ul>
        </div>
    </div>

    <script src="js/generate-candidate-pages.js"></script>
    <script>
        function showStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }
        
        function showOutput(content) {
            const outputEl = document.getElementById('output');
            outputEl.textContent = content;
        }
        
        function appendOutput(content) {
            const outputEl = document.getElementById('output');
            outputEl.textContent += content + '\n';
        }
        
        async function startGeneration() {
            try {
                showStatus('🚀 候補者ページ生成を開始しています...', 'loading');
                showOutput('');
                
                // APIからデータを取得
                const API_URL = 'https://script.google.com/macros/s/AKfycbxYQFMMz-Xh2vIDrj6FznzbuunLbdK26_oWz32KM3YjOIgQ6cmDQNV1KzMIEElUp16K/exec';
                
                appendOutput('📡 APIからデータを取得中...');
                
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const candidatesData = await response.json();
                appendOutput(`✅ 候補者データ取得完了: ${candidatesData.length}名`);
                
                showStatus(`📄 ${candidatesData.length}個の候補者ページを生成中...`, 'loading');
                
                // 各候補者のページを生成
                for (let i = 0; i < candidatesData.length; i++) {
                    const candidate = candidatesData[i];
                    const candidateHtml = generateCandidateDetailHTML(candidate, i);
                    const filename = `candidate-${i + 1}.html`;
                    
                    appendOutput(`\n=== ${filename} ===`);
                    appendOutput(candidateHtml);
                    appendOutput(`=== ${filename} 終了 ===\n`);
                }
                
                showStatus(`✅ 候補者ページ生成完了! ${candidatesData.length}個のファイルのHTMLが生成されました。`, 'success');
                appendOutput('\n🎉 全ての候補者ページのHTMLが生成されました！');
                appendOutput('上記のHTMLコードをコピーして、対応するファイルに保存してください。');
                
            } catch (error) {
                console.error('❌ 生成エラー:', error);
                showStatus(`❌ エラーが発生しました: ${error.message}`, 'error');
                appendOutput(`\nエラー: ${error.message}`);
            }
        }
        
        // generate-candidate-pages.js の関数を使用するための再定義
        function generateCandidateDetailHTML(candidate, index) {
            // 候補者基本情報を取得
            const name = getCandidateValue(candidate, [
                '【00_基本情報】氏名',
                '【00_基本情報】氏名（ふりがな）',
                '【基本情報】氏名',
                '【基本情報】氏名（ふりがな）',
                '氏名（ふりがな）',
                '氏名',
                '名前'
            ]) || `候補者${index + 1}`;
            
            const age = getCandidateValue(candidate, [
                '【00_基本情報】年齢',
                '【基本情報】年齢',
                '年齢'
            ]) || '不明';
            
            const party = getCandidateValue(candidate, [
                '【00_基本情報】所属政党',
                '【基本情報】所属政党',
                '所属政党',
                '政党'
            ]) || '無所属';
            
            const experience = getCandidateValue(candidate, [
                '【00_基本情報】当選回数',
                '【基本情報】当選回数',
                '当選回数',
                '当選歴'
            ]) || '不明';
            
            const imageUrl = getCandidateValue(candidate, [
                '【00_基本情報】あなたのプロフィール画像を添付してください。',
                '【基本情報】プロフィール画像',
                'プロフィール画像',
                '画像'
            ]) || '';
            
            // SNSリンクを取得
            const snsLinks = [];
            for (let i = 1; i <= 5; i++) {
                const url = candidate[`【00_基本情報】ウェブサイトやSNSアカウントのURL${i === 1 ? '①' : i === 2 ? '②' : i === 3 ? '③' : i === 4 ? '④' : '⑤'}`];
                if (url && url.trim()) {
                    snsLinks.push(url.trim());
                }
            }
            
            // 政策データを取得
            const policies = getPolicyData(candidate);
            
            // SNS HTML生成
            let snsHtml = '';
            if (snsLinks.length > 0) {
                snsHtml = `
                    <div class="sns-links">
                        <h4>ウェブサイト・SNS</h4>
                        ${snsLinks.map(url => {
                            const displayText = getSNSDisplayName(url);
                            const fullUrl = url.startsWith('http') ? url : `https://${url}`;
                            return `<a href="${fullUrl}" target="_blank" rel="noopener">${displayText}</a>`;
                        }).join('')}
                    </div>
                `;
            }
            
            // 政策 HTML生成
            let policiesHtml = '';
            if (policies.length > 0) {
                policies.forEach(categoryData => {
                    policiesHtml += `
                        <div style="margin-top: 2rem; margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; border-radius: 8px; font-weight: 600;">
                            📋 ${categoryData.category}
                        </div>
                    `;
                    
                    categoryData.questions.forEach(question => {
                        const answerClass = (question.answer && question.answer.toString().trim()) ? '' : ' style="color: #9ca3af; font-style: italic;"';
                        const displayAnswer = (question.answer && question.answer.toString().trim()) ? question.answer.toString().trim() : '回答なし';
                        
                        policiesHtml += `
                            <div class="policy-item">
                                <div><strong>Q:</strong> ${question.text}</div>
                                <div${answerClass}><strong>A:</strong> ${displayAnswer}</div>
                            </div>
                        `;
                    });
                });
            }
            
            const partyClass = getPartyClass(party);
            
            return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${name} | 候補者詳細 - 加賀みらいチョイス</title>
    <meta name="description" content="${name}（${party}）の詳細情報と政策。2025年加賀市議会議員選挙立候補者。">
    <meta name="keywords" content="加賀市,議会議員,選挙,2025年,${name},${party},政策,候補者">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/main.css">
    
    <!-- OGP設定 -->
    <meta property="og:title" content="${name} | 候補者詳細 - 加賀みらいチョイス">
    <meta property="og:description" content="${name}（${party}）の詳細情報と政策。2025年加賀市議会議員選挙立候補者。">
    <meta property="og:type" content="profile">
    <meta property="og:url" content="https://politi-kaga.github.io/kaga-mirai-choice/candidates/candidate-${index + 1}.html">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="${name} | 候補者詳細">
    <meta name="twitter:description" content="${name}（${party}）の詳細情報と政策">
    
    <!-- 構造化データ -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "${name}",
        "description": "${name}（${party}）- 2025年加賀市議会議員選挙立候補者",
        "url": "https://politi-kaga.github.io/kaga-mirai-choice/candidates/candidate-${index + 1}.html",
        "memberOf": {
            "@type": "PoliticalParty",
            "name": "${party}"
        }
    }
    </script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="../index.html" class="logo">
                <div class="logo-icon">🗳️</div>
                加賀みらいチョイス
            </a>
            <div class="nav-links">
                <a href="../index.html">ホーム</a>
                <a href="index.html">候補者一覧</a>
                <a href="../comparison/index.html">政策比較</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <section class="hero">
            <h1>候補者詳細</h1>
        </section>

        <div class="candidate-detail">
            <div class="candidate-header">
                <div class="candidate-photo-large">
                    ${imageUrl ? 
                        `<img src="${toDriveImageUrl(imageUrl, 600)}" alt="${name}の写真" 
                              onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=&quot;font-size: 1rem; color: #6b7280; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;&quot;>写真<br>準備中</span>';" 
                              loading="lazy" 
                              referrerpolicy="no-referrer">` : 
                        '<span style="font-size: 1rem; color: #6b7280; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">写真<br>準備中</span>'
                    }
                </div>
                <div class="candidate-basic-info">
                    <h2>${name}</h2>
                    <div class="info-row">
                        <span>年齢:</span>
                        <span>${age}歳</span>
                    </div>
                    <div class="info-row">
                        <span>当選歴:</span>
                        <span>${experience}</span>
                    </div>
                    <div class="info-row">
                        <span>政党:</span>
                        <span class="party-badge ${partyClass}">${party}</span>
                    </div>
                    ${snsHtml}
                </div>
            </div>

            <div class="policy-section">
                <h3>政策</h3>
                ${policiesHtml}
            </div>
        </div>

        <div style="text-align: center; margin: 2rem 0;">
            <a href="index.html" class="back-button">← 候補者一覧に戻る</a>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-about">
                    <a href="https://surf-hedge-480.notion.site/26b6a817b5fe80c994e9ce34982feb69" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="footer-link">
                        加賀みらいチョイスについて
                    </a>
                </div>
                <div class="footer-info">
                    <p class="footer-org">運営：加賀みらいチョイス運営委員会</p>
                    <p class="footer-contact">
                        連絡先：
                        <a href="mailto:kaga.democracy@gmail.com" class="footer-email">
                            kaga.democracy@gmail.com
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>`;
        }
        
        // 必要な関数を再定義（generate-candidate-pages.jsと同じ内容）
        function getCandidateValue(candidate, searchTerms) {
            for (const term of searchTerms) {
                const value = candidate[term];
                if (value && value.toString().trim()) {
                    return value.toString().trim();
                }
            }
            
            const keys = Object.keys(candidate);
            for (const term of searchTerms) {
                const matchKey = keys.find(key => key.includes(term.replace(/【.*?】/, '')));
                if (matchKey && candidate[matchKey] && candidate[matchKey].toString().trim()) {
                    return candidate[matchKey].toString().trim();
                }
            }
            
            return null;
        }
        
        function getPolicyData(candidate) {
            const policies = [];
            const questionsByCategory = {};
            
            Object.keys(candidate).forEach(key => {
                const categoryMatch = key.match(/【(\d+_[^】]+)】(.+)/);
                if (categoryMatch && !key.includes('00_基本情報')) {
                    const fullCategoryName = categoryMatch[1];
                    const categoryName = fullCategoryName.replace(/^\d+_/, '');
                    const questionText = categoryMatch[2];
                    const answer = candidate[key];
                    
                    if (!questionsByCategory[fullCategoryName]) {
                        questionsByCategory[fullCategoryName] = {
                            category: categoryName,
                            questions: []
                        };
                    }
                    
                    questionsByCategory[fullCategoryName].questions.push({
                        text: questionText,
                        answer: answer
                    });
                }
            });
            
            const sortedCategories = Object.keys(questionsByCategory).sort((a, b) => {
                const aNum = parseInt(a.match(/^(\d+)/)?.[1] || '999');
                const bNum = parseInt(b.match(/^(\d+)/)?.[1] || '999');
                
                if (aNum !== bNum) {
                    return aNum - bNum;
                }
                
                return a.localeCompare(b);
            });
            
            sortedCategories.forEach(categoryKey => {
                policies.push(questionsByCategory[categoryKey]);
            });
            
            return policies;
        }
        
        function toDriveImageUrl(url, size = 400) {
            if (!url || typeof url !== 'string') {
                return '';
            }
            
            let fileId = null;
            const patterns = [
                /\/file\/d\/([a-zA-Z0-9_-]+)\/view/,
                /\/file\/d\/([a-zA-Z0-9_-]+)/,
                /\/d\/([a-zA-Z0-9_-]+)/,
                /id=([a-zA-Z0-9_-]+)/,
                /open\?id=([a-zA-Z0-9_-]+)/,
                /^([a-zA-Z0-9_-]{25,})$/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    fileId = match[1];
                    break;
                }
            }
            
            if (!fileId) {
                return url;
            }
            
            return `https://lh3.googleusercontent.com/d/${fileId}=w${size}-h${size}-c`;
        }
        
        function getSNSDisplayName(url) {
            const lowerUrl = url.toLowerCase();
            if (lowerUrl.includes('twitter') || lowerUrl.includes('x.com')) return 'X (Twitter)';
            if (lowerUrl.includes('facebook')) return 'Facebook';
            if (lowerUrl.includes('instagram')) return 'Instagram';
            if (lowerUrl.includes('youtube')) return 'YouTube';
            if (lowerUrl.includes('tiktok')) return 'TikTok';
            if (lowerUrl.includes('line')) return 'LINE';
            if (lowerUrl.includes('mixi')) return 'mixi';
            if (lowerUrl.includes('ameba')) return 'Ameba';
            return 'ウェブサイト';
        }
        
        function getPartyClass(party) {
            if (party.includes('自民') || party.includes('自由民主')) return 'party-ldp';
            if (party.includes('立憲') || party.includes('立憲民主')) return 'party-constitutional';
            if (party.includes('公明')) return 'party-komeito';
            if (party.includes('維新') || party.includes('日本維新')) return 'party-ishin';
            if (party.includes('共産') || party.includes('日本共産')) return 'party-communist';
            if (party.includes('国民') || party.includes('国民民主')) return 'party-kokumin';
            return 'party-independent';
        }
    </script>
</body>
</html>